<!DOCTYPE html>
<html lang="en">
<head>
        <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
        <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
        <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
        <link rel="manifest" href="/site.webmanifest">
        <!-- <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">-->
        <link rel="stylesheet" href="bootstrap.min.css">
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Delete Users</title>
</head>
<body>

<nav class="navbar navbar-expand-lg navbar-light bg-light">
    <div class="container-fluid">
        <a class="navbar-brand" href="index.html">zoom api</a>
        <div class="collapse navbar-collapse" id="navbarNav">
            <ul class="navbar-nav">
                <li class="nav-item"><a class="nav-link" href="index.html">generate token</a></li>
                <li class="nav-item"><a class="nav-link" href="list_users.html">list users</a></li>
                <li class="nav-item"><a class="nav-link active" href="delete_users.html">delete users</a></li>
                <li class="nav-item"><a class="nav-link" href="extra_commands.html">extra command</a></li>
                <li class="nav-item"><a class="nav-link" href="README.html">README</a></li>
            </ul>
        </div>
    </div>
</nav>

<div class="container mt-5">
    <h1 class="text-center">Delete Users</h1>
    <form id="deleteUsersForm" enctype="multipart/form-data">
        <div class="mb-5">
            <label for="bearer_token" class="form-label">Bearer Token</label>
            <input type="text" class="form-control" id="bearer_token" name="bearer_token" required>
        </div>
        <div class="mb-5">
            <label for="csv_file" class="form-label">Upload CSV File</label>
            <input type="file" class="form-control" id="csv_file" name="csv_file" accept=".csv" required>
        </div>
        <button type="submit" class="btn btn-danger w-100">DELETE USERS</button>
    </form>
    <div id="deleteStatus" class="mt-3" style="max-height: 500px; overflow-y: auto;"></div>
</div>






<script>
document.getElementById('deleteUsersForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    const formData = new FormData();
    const bearerToken = document.getElementById('bearer_token').value;
    const csvFile = document.getElementById('csv_file').files[0];
    const statusDiv = document.getElementById('deleteStatus');

    if (!bearerToken || !csvFile) {
        statusDiv.innerHTML = '<p class="text-danger">All fields are required.</p>';
        return;
    }

    formData.append('bearer_token', bearerToken);
    formData.append('csv_file', csvFile);
    statusDiv.innerHTML = '';

    try {
        const response = await fetch('delete_users.php', { method: 'POST', body: formData });

        if (!response.body) {
            throw new Error('Streaming not supported');
        }

        const reader = response.body.getReader();
        const decoder = new TextDecoder();
        let buffer = '';

        while (true) {
            const { done, value } = await reader.read();
            if (done) break;

            buffer += decoder.decode(value, { stream: true });
            const lines = buffer.split('\n');
            buffer = lines.pop(); // Keep incomplete line

            for (const line of lines) {
                const trimmed = line.trim();
                if (trimmed.startsWith('{')) {
                    try {
                        const data = JSON.parse(trimmed);
                        updateStatus(data, statusDiv);
                    } catch (err) {
                        console.warn('Parse error:', err, line);
                    }
                }
            }
        }
    } catch (error) {
        if (!error.message.includes('abort')) {
            statusDiv.innerHTML += `<p class="text-danger"><strong>Error:</strong> ${error.message}</p>`;
        }
    }
});


function updateStatus(data, statusDiv) {
    const progressLineId = 'progressLine';
    let progressLine = document.getElementById(progressLineId);

    if (data.error) {
        statusDiv.innerHTML += `<p class="text-danger"><strong>Error:</strong> ${data.error}</p>`;
        return;
    }

    if (data.status === 'start') {
        statusDiv.innerHTML += `<p>Starting deletion of <strong>${data.total}</strong> users...</p>`;
        statusDiv.innerHTML += `<div class="progress mb-3">
            <div id="progressBar" class="progress-bar bg-danger" style="width:0%">0/${data.total}</div>
        </div>`;
        // Single status line
        statusDiv.innerHTML += `<p id="${progressLineId}" class="text-muted small">
        Waiting for first result...
        </p>`;
        return;
    }

    if (data.status === 'progress') {
        const bar = document.getElementById('progressBar');
        if (bar) {
            const progress = Math.round((data.current / data.total) * 100);
            bar.style.width = `${progress}%`;
            bar.textContent = `${data.current}/${data.total}`;
        }

        const icon = data.success ? '-' : '+';
        const message = data.success
            ? 'Deleted'
            : data.response ? JSON.parse(data.response)?.message || data.httpCode : data.httpCode;

        // Update single line
        if (!progressLine) {
            progressLine = document.getElementById(progressLineId);
        }

        if (progressLine) {
            progressLine.innerHTML = `
                Processing <strong>${data.current}</strong> of <strong>${data.total}</strong> |
                Last: <strong>${data.identifier}</strong> ${icon} (${message}) |
                <span class="text-success">Deleted: ${data.deleted}</span>
            `;
        }

        // Auto-scroll to keep top visible
        statusDiv.scrollTop = 0;
        return;
    }

    if (data.status === 'complete') {
        const color = data.deleted > 0 ? 'success' : 'warning';
        const msg = data.deleted === data.total
            ? `All ${data.deleted} users deleted!`
            : `${data.deleted} of ${data.total} deleted.`;

        statusDiv.innerHTML += `<p class="text-${color} mt-3"><strong>${msg}</strong></p>`;
        return;
    }
}

</script>



</body>
</html>
